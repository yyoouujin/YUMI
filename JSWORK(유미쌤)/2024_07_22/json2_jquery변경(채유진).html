<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Json2_jquery변경</title>
    <script
    src="https://code.jquery.com/jquery-3.7.1.js"
    integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
    crossorigin="anonymous"
  ></script>
  </head>
  <body>
    <input id="txtDt" value="20240717" /><button type="button" id="btnDt">
      조회
    </button>
    <table border="1">
      <thead>
        <tr>
          <th>순위</th>
          <th>제목</th>
          <th>개봉일자</th>
          <th>선택</th>
        </tr>
      </thead>
      <tbody id="result"></tbody>
    </table>

    <div id="info">

    </div>

    <script>
      //-------------------
      // 조회버튼 이벤트 핸들러( 박스오피스 조회 ) : url 뒤에 오는건 날짜
      //-------------------
      $('#btnDt').on("click", function () {
        let url =
          "https://kobis.or.kr/kobisopenapi/webservice/rest/boxoffice/searchDailyBoxOfficeList.json?key=f5eef3421c602c6cb7ea224104795888&targetDt=" +
          $(txtDt).val();
  
        $.ajax(url)
        .then(data => {
          movieListHandler(data);
        })
        
      });

      //-------------------
      // 박스오피스 조회결과 처리
      //-------------------
      function movieListHandler(movieList) {
        //첫번째 영화의 제목만 출력
        console.log(movieList.boxOfficeResult.dailyBoxOfficeList[0].movieNm);

        let list = movieList.boxOfficeResult.dailyBoxOfficeList;

        //영화목록 비우기
        $('#result').html('');

        $(list).each( (index, element) => {

          //$newTag = $(“<option>”)
          //$태그.data(“속성”, “값”) 안먹혀서 attr 로 한번에줌
          // let $tr = $("<tr>").attr('data-cd', element.movieCd);
          // $('#result').append($tr);

          //$태그.data(“속성”, “값”) 로 속성을 주면 DOM에선 확인이 안된다
          let $tr = $("<tr>").data("cd", element.movieCd);
          console.log($tr);
          $('#result').append($tr);

          let $tdRank = $("<td>").html(element.rank);
          $tr.append($tdRank);
          
          let $tdMovieNm = $("<td>").html(element.movieNm);
          $tr.append($tdMovieNm);

          let $tdOpenDt = $("<td>").html(element.openDt);
          $tr.append($tdOpenDt);

          let $button = $("<button>").html('선택');
          $tr.append($button);

        });

      }


      //--------------------------------------
      // 영화선택 핸들러( 영화 상세정보 조회  )
      //--------------------------------------
      //그룹이벤트   tbody ->  button -> closet  tr -> data-cd alert

      $('#result').on("click", function () {
        if ( $(event.target[name = 'button']) ) {
          let $movieCd = $(event.target).closest('tr').data('cd');
          alert($movieCd);

          let mvurl = "https://www.kobis.or.kr/kobisopenapi/webservice/rest/movie/searchMovieInfo.json?key=f5eef3421c602c6cb7ea224104795888&movieCd="+$movieCd;

          $.ajax(mvurl)
          .then (data => {
            movieDetailHandler(data);
          })

        }

      });

      //-------------------------------
      //영화 상세정보 조회결과 처리
      //-------------------------------

      function movieDetailHandler(movieDetail) {
        console.log(movieDetail);

        //상세정보 비우기
        $('#info').html('');

        //감독
        let director = movieDetail.movieInfoResult.movieInfo.directors[0].peopleNm;

        let $directorTag = $('<h2>').html('감독 - ' + director);
        $('#info').append($directorTag);


        let $actorTag = $('<h3>').html('배우');
        $('#info').append($actorTag);

        //배우(전체) : 배열타입 (첫번째 필드값 peopleNm 을 가져와야한다)

        let actors = movieDetail.movieInfoResult.movieInfo.actors.forEach(actor => {
          console.log(actor.peopleNm);

          let $actorsTag = $('<p>').html(actor.peopleNm);
          $('#info').append($actorsTag);

        })

      }



    </script>
  </body>
</html>
